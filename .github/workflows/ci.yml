name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: rust-validation-${{ github.head_ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: full
  RUST_LOG: "gadget=trace"
  CARGO_TERM_COLOR: always
  IN_CI: "true"

jobs:
  formatting:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt

      - name: Check Formatting
        run: cargo fmt -- --check

  linting:
    timeout-minutes: 120
    name: cargo clippy
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v2

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Verify Forge installation
        run: forge --version

      - name: install rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - uses: swatinem/rust-cache@v2
        with:
          cache-on-failure: "true"

      - name: install protobuf and gmp
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev libgmp-dev

      - name: Run Clippy
        run: cargo clippy --tests --examples -- -D warnings

  testing:
    timeout-minutes: 30
    name: cargo test
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
    strategy:
      fail-fast: false
      matrix:
        package:
          [
            # Blueprint examples
            incredible-squaring-blueprint,
            incredible-squaring-blueprint-eigenlayer,

            # Job system
            blueprint-core,
            blueprint-router,
            blueprint-runner,

            # Extras
            blueprint-tangle-extra,
            blueprint-evm-extra,
            blueprint-producers-extra,

            # Utils
            blueprint-util-meta,
            blueprint-manager,
            blueprint-build-utils,
            gadget-blueprint-serde,
            gadget-utils,
            gadget-utils-evm,
            gadget-utils-tangle,
            gadget-utils-eigenlayer,

            # Testing utils
            gadget-testing-utils,
            gadget-core-testing-utils,
            gadget-tangle-testing-utils,
            gadget-anvil-testing-utils,
            gadget-eigenlayer-testing-utils,

            # Macros
            blueprint-macros,
            gadget-blueprint-proc-macro-core,
            gadget-context-derive,

            # Stores
            gadget-stores,
            gadget-store-local-database,

            # Clients
            gadget-clients,
            gadget-client-core,
            gadget-client-eigenlayer,
            gadget-client-evm,
            gadget-client-tangle,
            gadget-contexts,

            # P2P
            gadget-networking,
            gadget-networking-round-based-extension,

            # Executor
            gadget-executor,

            # Crypto
            gadget-crypto-core,
            gadget-crypto-k256,
            gadget-crypto-sr25519,
            gadget-crypto-ed25519,
            gadget-crypto-hashing,
            gadget-crypto-bls,
            gadget-crypto-bn254,
            gadget-crypto-sp-core,
            gadget-crypto,
            gadget-crypto-tangle-pair-signer,

            gadget-blueprint-serde,
            gadget-keystore,
            gadget-std,
            cargo-tangle,
          ]
    steps:
      - name: checkout code
        uses: actions/checkout@v2

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Verify Forge installation
        run: forge --version

      - name: install rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          toolchain: stable

      - uses: swatinem/rust-cache@v2
        with:
          cache-on-failure: "true"

      - name: install protobuf and gmp
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev libgmp-dev

      - uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Add extra args
        run: |
          # if test == "gadget_context_derive", add --features="networking", else ""
          if [[ "${{ matrix.package }}" == "gadget-context-derive" ]]; then
            echo "cargo_nextest_args=--features networking" >> $GITHUB_ENV
          elif [[ "${{ matrix.package }}" == "incredible-squaring-blueprint" || "${{ matrix.package }}" == "incredible-squaring-blueprint-eigenlayer" || "${{ matrix.package }}" == "blueprint-examples" ]]; then
            echo "cargo_nextest_args=--profile serial" >> $GITHUB_ENV
          else
            echo "cargo_nextest_args=--profile ci" >> $GITHUB_ENV
          fi

      - name: tests
        run: cargo nextest run --package ${{ matrix.package }} ${{ env.cargo_nextest_args }}

      # TODO: nextest doesn't support doc tests yet (https://github.com/nextest-rs/nextest/issues/16)
      - name: doc tests
        run: cargo test --package ${{ matrix.package }} --doc
